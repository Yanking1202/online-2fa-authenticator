<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Unlock Puzzle</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #eef; }
    h1 { color: #222; }
    .box { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    input, button, select { margin-top: 10px; padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
    button { background: #2196F3; color: white; cursor: pointer; }
    button:hover { background: #1976D2; }
    #output { margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Unlock Puzzle</h1>
  <p><a href="encrypter.html">Go to Encrypter</a></p>

  <div class="box">
    <label>Encrypted JSON:</label>
    <textarea id="encryptedJson" style="width:100%;height:100px;"></textarea>

    <label>Secret Key:</label>
    <input id="key" type="password">

    <button onclick="loadPuzzle()">Load Puzzle</button>
  </div>

  <div id="puzzle" class="box" style="display:none;">
    <h3 id="puzzleLabel"></h3>

    <div id="namesBox"></div>
    <div id="carsBox"></div>
    <div id="animalsBox"></div>

    <button onclick="check()">Unlock</button>
    <div id="output"></div>
  </div>

  <script>
    let puzzleData = null;
    let attempt = 0;
    let lockedUntil = 0;

    function loadPuzzle() {
      try {
        const encrypted = document.getElementById("encryptedJson").value.trim();
        const key = document.getElementById("key").value.trim();
        const decrypted = CryptoJS.AES.decrypt(encrypted, key).toString(CryptoJS.enc.Utf8);
        puzzleData = JSON.parse(decrypted);

        document.getElementById("puzzleLabel").textContent = puzzleData.label || "Puzzle";
        renderOptions("namesBox", "names", puzzleData.names);
        renderOptions("carsBox", "cars", puzzleData.cars);
        renderOptions("animalsBox", "animals", puzzleData.animals);

        document.getElementById("puzzle").style.display = "block";
      } catch (e) {
        alert("Failed to decrypt: wrong key or bad data");
      }
    }

    function renderOptions(containerId, field, items) {
      if (!items || !items.length) return;
      const container = document.getElementById(containerId);
      container.innerHTML = `<h4>${field}</h4>`;
      items.forEach((item,i) => {
        container.innerHTML += `<input type="text" id="${field}_${i}" placeholder="${item}">`;
      });
    }

    function check() {
      const now = Date.now();
      if (now < lockedUntil) {
        document.getElementById("output").textContent = `Wait ${Math.ceil((lockedUntil-now)/1000)}s before retrying.`;
        return;
      }

      const namesGuess = collectGuess("names", puzzleData.names.length);
      const carsGuess = collectGuess("cars", puzzleData.cars.length);
      const animalsGuess = collectGuess("animals", puzzleData.animals.length);

      if (arraysEqual(namesGuess, puzzleData.namesOrder) &&
          arraysEqual(carsGuess, puzzleData.carsOrder) &&
          arraysEqual(animalsGuess, puzzleData.animalsOrder)) {
        document.getElementById("output").textContent = "✅ Correct! Puzzle unlocked!";
      } else {
        attempt++;
        document.getElementById("output").textContent = "❌ Wrong order, try again.";

        if (puzzleData.delays && puzzleData.delays.length >= attempt) {
          const delaySec = puzzleData.delays[attempt-1];
          lockedUntil = Date.now() + delaySec*1000;
          document.getElementById("output").textContent += ` Locked for ${delaySec}s.`;
        }
      }
    }

    function collectGuess(field, count) {
      return Array.from({length: count}, (_,i)=>document.getElementById(`${field}_${i}`).value.trim()).filter(v=>v);
    }

    function arraysEqual(a,b) {
      if (!a || !b || a.length !== b.length) return false;
      return a.every((v,i)=>v===b[i]);
    }
  </script>
</body>
</html>
