<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Authenticator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/otpauth@9.0.2/dist/otpauth.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .container { width: 100%; max-width: 600px; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #1a73e8; text-align: center; }
        input, button { width: 100%; box-sizing: border-box; padding: 10px; margin-bottom: 15px; border-radius: 6px; border: 1px solid #ccc; }
        button { background: #1a73e8; color: #fff; cursor: pointer; border: none; font-weight: 600; }
        button:hover { background: #155ea6; }
        .hidden { display: none !important; }
        .drag-cloud { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; padding: 10px; border: 1px dashed #ccc; border-radius: 6px; min-height: 80px; }
        .drag-item { padding: 8px 12px; background: #eee; border-radius: 6px; cursor: grab; user-select: none; }
        #camera-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .unlocked-content { background: #f9f9f9; border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-top: 10px; }
    </style>
</head>
<body>
<div class="container">
    <div id="unlock-section">
        <h1>Secure Authenticator</h1>
        <p style="text-align:center;">Arrange the names in the correct order, enter your password, and click Unlock.</p>
        <div id="main-cloud" class="drag-cloud"></div>
        <input type="password" id="masterPassword" placeholder="Enter password">
        <label for="jsonUpload" style="display:block; margin-bottom:5px;">Load data from file:</label>
        <input type="file" id="jsonUpload" accept=".json">
        <button onclick="attemptUnlock()">Unlock</button>
    </div>

    <div id="auth-section" class="hidden"></div>
</div>

<div id="app-template" class="hidden">
    <h2>Authenticator</h2>
    <div id="qr-drop-zone"><p>Drag & Drop QR Code Image Here</p></div>
    <input type="text" id="secret" placeholder="Or enter your secret key">
    <button onclick="scanWithCamera()">Scan with Camera</button>
    <button onclick="generateCode()">Generate One-Time Code</button>
    <div style="text-align:center; margin:15px 0;">Code: <h2 id="code" style="margin:5px 0;">------</h2><span id="timer"></span></div>
    <hr>
    <div>
        <h3>Your Saved Codes</h3>
        <div id="rolling-cloud" class="drag-cloud"></div>
        <div id="rolling-codes-list" class="unlocked-content hidden">
             <div style="text-align:right; margin-bottom:10px; font-weight:600;">Refreshes in: <span id="rolling-timer">30</span>s</div>
        </div>
    </div>
    <hr>
    <div>
        <h3>Your Raw Keys</h3>
        <div id="raw-cloud" class="drag-cloud"></div>
        <div id="raw-keys-list" class="unlocked-content hidden"></div>
    </div>
</div>

<div id="camera-modal" class="hidden"><video id="camera-feed" playsinline></video></div>
<canvas id="qr-canvas" class="hidden"></canvas>

<script>
    let currentData = null; // Will hold the DECRYPTED data after unlock
    let encryptedBlob = null; // Will hold the ENCRYPTED string
    let singleCodeInterval = null;
    let rollingCodesInterval = null;

    // Load data source (default or uploaded) and display the public puzzle
    async function loadDataSource(source) {
        try {
            const fileContent = await source.text();
            const data = JSON.parse(fileContent);
            if (!data.puzzleWords || !data.encryptedData) {
                throw new Error("Invalid file format.");
            }
            encryptedBlob = data.encryptedData;
            populatePuzzle('main', data.puzzleWords, true);
        } catch (err) {
            alert(`Failed to load data source: ${err.message}`);
        }
    }

    // Load default.json on startup
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const response = await fetch('default.json');
            if (!response.ok) return;
            loadDataSource(response);
        } catch (err) {
            console.warn("Could not load default.json");
        }
    });

    // Handle file uploads
    document.getElementById('jsonUpload').addEventListener('change', function(e) {
        if (this.files.length > 0) {
            loadDataSource(this.files[0]);
        }
    });
    
    // The main unlock function performs the secure check
    function attemptUnlock() {
        const password = document.getElementById('masterPassword').value;
        const currentOrder = Array.from(document.getElementById('main-cloud').children).map(el => el.innerText);

        if (!password) { alert("Please enter your password."); return; }
        if (!encryptedBlob) { alert("No data loaded. Please upload a file or ensure default.json exists."); return; }

        try {
            // Step 1: Attempt to decrypt with the password
            const decrypted = CryptoJS.AES.decrypt(encryptedBlob, password).toString(CryptoJS.enc.Utf8);
            if (!decrypted) throw new Error('Decryption failed. Incorrect password.');
            
            const data = JSON.parse(decrypted);

            // Step 2: Immediately check if the puzzle order is correct
            if (currentOrder.join(',') !== data.mainPuzzleOrder.join(',')) {
                throw new Error("Incorrect name order!");
            }

            // Step 3: SUCCESS! Both factors are correct. Now unlock the app.
            currentData = data;
            document.getElementById('unlock-section').classList.add('hidden');
            const authSection = document.getElementById('auth-section');
            authSection.innerHTML = document.getElementById('app-template').innerHTML;
            authSection.classList.remove('hidden');
            
            populatePuzzle('rolling', data.rollingCloud.cloud);
            populatePuzzle('raw', data.rawCloud.cloud);

        } catch (error) {
            alert(`Unlock failed: ${error.message}`);
        }
    }

    // --- All other functions remain the same as the previous version ---
    // (Populate puzzles, check secondary puzzles, render codes, handle QR, etc.)
    function populatePuzzle(type, items, isMainPuzzle = false) {
        const cloud = document.getElementById(`${type}-cloud`);
        cloud.innerHTML = "";
        const itemsToDisplay = isMainPuzzle ? items.sort(() => Math.random() - 0.5) : items;
        itemsToDisplay.forEach(item => {
            const div = document.createElement("div"); div.className = "drag-item"; div.innerText = item; cloud.appendChild(div);
        });
        const options = { animation: 150 };
        if (!isMainPuzzle) { options.onEnd = () => checkSecondaryPuzzle(type); }
        new Sortable(cloud, options);
    }
    
    function checkSecondaryPuzzle(type) {
        const order = Array.from(document.getElementById(`${type}-cloud`).children).map(el => el.innerText).join(',');
        const isRollingCorrect = order === currentData.rollingCloud.order.join(',');
        const isRawCorrect = order === currentData.rawCloud.order.join(',');

        if (type === 'rolling') {
            document.getElementById('rolling-codes-list').classList.toggle('hidden', !isRollingCorrect);
            if (isRollingCorrect) renderRollingCodes(); else if (rollingCodesInterval) clearInterval(rollingCodesInterval);
        } else if (type === 'raw') {
            document.getElementById('raw-keys-list').classList.toggle('hidden', !isRawCorrect);
            if (isRawCorrect) renderRawKeys();
        }
    }

    function renderRollingCodes() {
        if (rollingCodesInterval) clearInterval(rollingCodesInterval);
        const container = document.getElementById('rolling-codes-list');
        container.innerHTML = `<div style="text-align:right; margin-bottom:10px; font-weight:600;">Refreshes in: <span id="rolling-timer">30</span>s</div>`;
        const totpInstances = currentData.secrets.map(secret => ({
            label: secret.label,
            instance: new OTPAuth.TOTP({ secret: OTPAuth.Secret.fromBase32(secret.key) })
        }));
        const updateCodes = () => {
            totpInstances.forEach(item => {
                let el = document.getElementById(`code-for-${item.label}`);
                if (!el) {
                    const div = document.createElement('div');
                    div.className = 'rolling-code-item';
                    div.innerHTML = `<span><strong>${item.label}</strong></span><span class="code" id="code-for-${item.label}"></span>`;
                    container.appendChild(div);
                }
                el.textContent = item.instance.generate();
            });
        };
        rollingCodesInterval = setInterval(() => {
            const seconds = 30 - new Date().getSeconds() % 30;
            document.getElementById('rolling-timer').textContent = seconds;
            if (seconds === 30) updateCodes();
        }, 1000);
        updateCodes();
    }

    function renderRawKeys() {
        document.getElementById('raw-keys-list').innerHTML = currentData.secrets.map(s => `<div><strong>${s.label}:</strong> ${s.key}</div>`).join('');
    }
    
    // QR and one-off code functions would go here...
</script>
</body>
</html>
