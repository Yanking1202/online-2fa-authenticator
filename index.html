<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Secure Authenticator</title>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/otpauth@9.0.2/dist/otpauth.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<style>
  body { font-family: sans-serif; background:#f8f9fa; margin:0; padding:0;}
  .container { max-width:600px; margin:50px auto; background:#fff; padding:30px; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,0.05);}
  h1,h2 { text-align:center; color:#1a73e8; }
  input[type=text],input[type=password],button,textarea { width:100%; padding:10px; margin:10px 0; font-size:1rem; }
  .hidden { display:none; }
  .list { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin:10px 0; }
  .list div { padding:10px 15px; background:#eee; border-radius:8px; cursor:pointer; user-select:none; }
  .code-result { text-align:center; background:#f1f3f4; padding:15px; margin-top:15px; border-radius:8px; font-weight:600; }
</style>
</head>

<body>
<div class="container" id="unlockSection">
  <h1>Unlock Authenticator</h1>
  <input type="password" id="mainPassword" placeholder="Enter password">
  <p>Arrange 10 names in correct order:</p>
  <div class="list" id="authNames"></div>
  <button onclick="tryUnlock()">Unlock</button>
</div>

<div class="container hidden" id="authAppSection">
  <h1>Authenticator App</h1>
  <input type="text" id="secret" placeholder="Enter your secret key or QR hash">
  <button onclick="generateCode()">Generate Code</button>
  <div class="code-result">Current Code: <span id="code">------</span><br/><span id="timer"></span></div>
  <button onclick="copyCode()">Copy Code</button>

  <h2>Rolling Codes Unlock</h2>
  <div class="list" id="rollingList"></div>
  <div id="rollingCodes" class="hidden code-result"></div>

  <h2>Raw TOTP Keys Unlock</h2>
  <div class="list" id="rawList"></div>
  <div id="rawKeys" class="hidden code-result"></div>

  <h2>Upload New JSON</h2>
  <input type="file" id="jsonFile" accept=".json">
  <button onclick="loadJSONFile()">Load JSON</button>
</div>

<script>
let encryptedJSON = "https://YOUR_GITHUB_RAW_URL/totp.json"; // replace with your JSON raw link
let decryptedData = null;
let password = "";
let authNamesOrder = [];
let rollingOrder = [];
let rawOrder = [];
let rollingSecrets = [];
let rawSecrets = [];

// Fetch encrypted JSON
async function fetchEncryptedJSON(){
    const res = await fetch(encryptedJSON);
    const json = await res.json();
    return json.encryptedData;
}

// Load JSON from uploaded file
function loadJSONFile(){
    const file = document.getElementById('jsonFile').files[0];
    if(!file) return alert("Select JSON file");
    const reader = new FileReader();
    reader.onload = e=>{
        const json = JSON.parse(e.target.result);
        const decrypted = CryptoJS.AES.decrypt(json.encryptedData, password).toString(CryptoJS.enc.Utf8);
        try{
            decryptedData = JSON.parse(decrypted);
            setupLists();
            alert("JSON loaded!");
        } catch(e){
            alert("Failed to decrypt JSON with current password");
        }
    };
    reader.readAsText(file);
}

// Initialize name lists for unlock
function setupLists(){
    authNamesOrder = [...decryptedData.authOrder];
    rollingOrder = [...decryptedData.carOrder];
    rawOrder = [...decryptedData.carOrder]; // rawOrder = decryptedData.animalOrder
    rollingSecrets = decryptedData.totpSecrets; 
    rawSecrets = decryptedData.totpSecrets;

    shuffleDisplay('authNames', authNamesOrder);
    shuffleDisplay('rollingList', rollingOrder);
    shuffleDisplay('rawList', rawOrder);
}

// Shuffle array display
function shuffleDisplay(containerId, arr){
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    let shuffled = arr.slice().sort(()=>Math.random()-0.5);
    shuffled.forEach(name=>{
        let div = document.createElement('div');
        div.textContent = name;
        container.appendChild(div);
    });
    new Sortable(container, { animation:150 });
}

// Try unlocking page
function tryUnlock(){
    password = document.getElementById('mainPassword').value;
    const container = document.getElementById('authNames');
    const arranged = Array.from(container.children).map(d=>d.textContent);
    if(arranged.join(',') === authNamesOrder.join(',')){
        // Decrypt data
        fetchEncryptedJSON().then(async enc=>{
            const decrypted = CryptoJS.AES.decrypt(enc, password).toString(CryptoJS.enc.Utf8);
            try{
                decryptedData = JSON.parse(decrypted);
                setupLists();
                document.getElementById('unlockSection').classList.add('hidden');
                document.getElementById('authAppSection').classList.remove('hidden');
            } catch(e){
                alert("Incorrect password or corrupted JSON");
            }
        });
    } else {
        alert("Names order incorrect");
    }
}

// --- Authenticator App ---
let timerInterval;
function normalizeSecret(secret){ return secret.replace(/\s+/g,'').toUpperCase(); }
function getURLParameter(name){ const urlParams=new URLSearchParams(window.location.search); return urlParams.get(name);}
function generateCode(){
    let secret = document.getElementById('secret').value.trim();
    if(!secret) secret = getURLParameter("hash");
    if(!secret) return alert('Enter secret key or QR hash');
    secret = normalizeSecret(secret);
    if(!/^[A-Z2-7]+$/.test(secret)) return alert('Invalid key format');
    if(timerInterval) clearInterval(timerInterval);
    try{
        const totp = new OTPAuth.TOTP({algorithm:'SHA1',digits:6,period:30,secret:OTPAuth.Secret.fromBase32(secret)});
        updateCode(totp);
        timerInterval = setInterval(()=>updateCode(totp),1000);
    }catch(e){ alert('Error generating code'); console.error(e);}
}
function updateCode(totp){
    const code = totp.generate();
    document.getElementById('code').textContent = code;
    const remainingSeconds = 30 - Math.round(Date.now()/1000)%30;
    const timerText = `${remainingSeconds} second${remainingSeconds!==1?'s':''}`;
    document.getElementById('timer').textContent = timerText;
    document.getElementById('timer').style.color = remainingSeconds<=5?'#e74c3c':'#27ae60';
}
function copyCode(){ navigator.clipboard.writeText(document.getElementById('code').innerText).then(()=>alert('Copied!')).catch(()=>alert('Failed'));}

// --- Drag Drop unlocks ---
function checkRollingUnlock(){
    const container = document.getElementById('rollingList');
    const arranged = Array.from(container.children).map(d=>d.textContent);
    if(arranged.slice(0,5).join(',') === rollingOrder.slice(0,5).join(',')){
        document.getElementById('rollingCodes').classList.remove('hidden');
        document.getElementById('rollingCodes').textContent = "Rolling codes: " + rollingSecrets.join(', ');
    }
}
function checkRawUnlock(){
    const container = document.getElementById('rawList');
    const arranged = Array.from(container.children).map(d=>d.textContent);
    if(arranged.slice(0,5).join(',') === rawOrder.slice(0,5).join(',')){
        document.getElementById('rawKeys').classList.remove('hidden');
        document.getElementById('rawKeys').textContent = "Raw TOTP keys: " + rawSecrets.join(', ');
    }
}

// Initialize sortable check
document.addEventListener('DOMContentLoaded', ()=>{
    setupLists();
    new Sortable(document.getElementById('rollingList'), { animation:150, onSort:checkRollingUnlock });
    new Sortable(document.getElementById('rawList'), { animation:150, onSort:checkRawUnlock });
});
</script>
</body>
</html>
