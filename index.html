<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Authenticator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/otpauth@9.0.2/dist/otpauth.umd.min.js"></script>
    <style>/* Styles unchanged */</style>
</head>
<body>
<div class="container">
    <div id="unlock-section">
        <h1>Secure Authenticator</h1>
        <div id="main-cloud" class="drag-cloud"></div>
        <input type="password" id="masterPassword" placeholder="Enter password">
        <input type="file" id="jsonUpload" accept=".json">
        <button onclick="attemptUnlock()">Unlock</button>
    </div>
    <div id="auth-section" class="hidden"></div>
</div>

<div id="app-template" class="hidden">
    <h2>Authenticator</h2>
    <input type="text" id="secret" placeholder="Generate a one-off code">
    <button onclick="generateCode()">Generate</button>
    <div id="code-display" style="text-align:center; margin:15px 0;"></div>
    <hr>
    <div>
        <h3>Rolling Codes Vault</h3>
        <div id="rolling-cloud" class="drag-cloud"></div>
        <div id="rolling-codes-list" class="unlocked-content hidden"></div>
    </div>
    <hr>
    <div>
        <h3>Raw Keys Vault</h3>
        <div id="raw-cloud" class="drag-cloud"></div>
        <div id="raw-keys-list" class="unlocked-content hidden"></div>
    </div>
</div>
<script>
    let sessionPassword = null;
    let appVaultBlob = null, rollingVaultBlob = null, rawVaultBlob = null;
    let appData = null, rollingData = null, rawData = null;
    let rollingCodesInterval = null;

    async function loadDataSource(source) {
        try {
            const data = JSON.parse(await source.text());
            appVaultBlob = data.appVault;
            rollingVaultBlob = data.rollingVault;
            rawVaultBlob = data.rawVault;
            populatePuzzle('main', data.mainPuzzleWords);
        } catch (err) { alert(`Failed to load data: ${err.message}`); }
    }

    document.addEventListener('DOMContentLoaded', async () => { /* unchanged */ });
    document.getElementById('jsonUpload').addEventListener('change', function(e) { /* unchanged */ });
    
    function attemptUnlock() {
        const password = document.getElementById('masterPassword').value;
        const mainPuzzleSolution = Array.from(document.getElementById('main-cloud').children).map(el => el.innerText);
        if (!password || mainPuzzleSolution.length === 0) { alert("Password and puzzle solution are required."); return; }

        try {
            const appVaultKey = CryptoJS.PBKDF2(password, mainPuzzleSolution.join(''), { keySize: 256/32, iterations: 1000 });
            const decrypted = CryptoJS.AES.decrypt(appVaultBlob, appVaultKey.toString()).toString(CryptoJS.enc.Utf8);
            if (!decrypted) throw new Error('Incorrect password or puzzle order.');
            
            appData = JSON.parse(decrypted);
            sessionPassword = password;
            
            document.getElementById('unlock-section').classList.add('hidden');
            const authSection = document.getElementById('auth-section');
            authSection.innerHTML = document.getElementById('app-template').innerHTML;
            authSection.classList.remove('hidden');
            
            populatePuzzle('rolling', appData.rollingPuzzle.cloud);
            populatePuzzle('raw', appData.rawPuzzle.cloud);

        } catch (error) { alert(`Unlock failed: ${error.message}`); }
    }
    
    function populatePuzzle(type, items) {
        const cloud = document.getElementById(`${type}-cloud`);
        cloud.innerHTML = "";
        items.sort(() => Math.random() - 0.5).forEach(item => {
            const div = document.createElement("div"); div.className = "drag-item"; div.innerText = item; cloud.appendChild(div);
        });
        new Sortable(cloud, { animation: 150, onEnd: () => checkSecondaryPuzzle(type) });
    }
    
    function checkSecondaryPuzzle(type) {
        const cloud = document.getElementById(`${type}-cloud`);
        const userSolution = Array.from(cloud.children).map(el => el.innerText);
        
        let vaultBlob, correctOrder, dataTarget, renderFn;
        if (type === 'rolling') {
            vaultBlob = rollingVaultBlob;
            correctOrder = appData.rollingPuzzle.order;
            dataTarget = rollingData;
            renderFn = () => {
                rollingData = decryptAndStore(vaultBlob, userSolution.join(''));
                if(rollingData) renderRollingCodes();
            };
        } else { // type === 'raw'
            vaultBlob = rawVaultBlob;
            correctOrder = appData.rawPuzzle.order;
            dataTarget = rawData;
            renderFn = () => {
                rawData = decryptAndStore(vaultBlob, userSolution.join(''));
                if(rawData) renderRawKeys();
            };
        }
        
        const isCorrect = userSolution.join(',') === correctOrder.join(',');
        document.getElementById(`${type}-codes-list` || `${type}-keys-list`).classList.toggle('hidden', !isCorrect);
        if (isCorrect) {
            if (!dataTarget) renderFn(); // Decrypt only if not already done
        } else {
            if (type === 'rolling' && rollingCodesInterval) clearInterval(rollingCodesInterval);
        }
    }

    function decryptAndStore(vaultBlob, puzzleSolution) {
        try {
            const vaultKey = CryptoJS.PBKDF2(sessionPassword, puzzleSolution, { keySize: 256/32, iterations: 1000 });
            const decrypted = CryptoJS.AES.decrypt(vaultBlob, vaultKey.toString()).toString(CryptoJS.enc.Utf8);
            return JSON.parse(decrypted);
        } catch (e) {
            alert("Vault decryption failed! The puzzle order is likely incorrect.");
            return null;
        }
    }

    function renderRollingCodes() { /* unchanged */ }
    function renderRawKeys() {
        document.getElementById('raw-keys-list').innerHTML = rawData.secrets.map(s => `<div><strong>${s.label}:</strong> ${s.key}</div>`).join('');
    }
    function generateCode() { /* unchanged */ }
</script>
</body>
</html>
